<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Pipeline 2.0 - The ML Roadmap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;        /* Cyan */
            --accent-glow: rgba(56, 189, 248, 0.3);
            --success: #4ade80;       /* Green */
            --warning: #f87171;       /* Red */
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --line-color: #334155;
        }

        * { box-sizing: border-box; }

        body {
            background-color: #020617;
            font-family: 'Urbanist', sans-serif;
            color: var(--text-main);
            margin: 0;
            padding: 40px 40px 100px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- HUBSPOT CONNECT BAR --- */
        .hubspot-bar {
            width: 100%;
            max-width: 800px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid var(--line-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--line-color);
            padding-bottom: 15px;
        }

        .bar-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .status-offline { background: rgba(148, 163, 184, 0.2); color: var(--text-muted); border: 1px solid var(--line-color); }
        .status-online { background: rgba(74, 222, 128, 0.2); color: var(--success); border: 1px solid var(--success); display: none; }
        .status-online.active { display: inline-block; }
        .status-offline.hidden { display: none; }

        .bar-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .hs-input {
            background: var(--bg-dark);
            border: 1px solid var(--line-color);
            color: var(--text-main);
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Urbanist', sans-serif;
            font-size: 14px;
            flex: 1;
            transition: all 0.2s;
        }
        .hs-input:focus { outline: none; border-color: var(--accent); }

        .hs-btn {
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hs-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .hs-btn:disabled { background: var(--text-muted); cursor: not-allowed; filter: grayscale(1); }

        /* Loading Spinner */
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Deal Context Info */
        .deal-context {
            font-size: 14px;
            color: var(--success);
            display: none;
            margin-top: 5px;
        }
        
        /* --- STAGE TAG (NEW) --- */
        .stage-tag {
            display: none; /* Hidden by default */
            background: rgba(168, 85, 247, 0.2); /* Purple background */
            border: 1px solid #a855f7;           /* Purple border */
            color: #e9d5ff;                      /* Light purple text */
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* --- INFO BADGES (Company Data Display) --- */
        .info-badge {
            display: none; /* Hidden by default */
            margin-left: auto;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .info-badge.has-data {
            background: rgba(74, 222, 128, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .info-badge.missing-data {
            background: rgba(248, 113, 113, 0.15);
            border: 1px solid var(--warning);
            color: var(--warning);
        }
        
        .info-badge i {
            margin-right: 5px;
        }
        
        .info-badge.missing-data::after {
            content: " - REQUIRED";
            font-weight: 700;
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        /* --- ROADMAP STYLES --- */
        h1 { margin: 0; font-size: 48px; text-align: center; background: linear-gradient(90deg, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 24px; color: var(--text-muted); margin-bottom: 60px; font-weight: 400; text-align: center; }

        .roadmap-container { max-width: 800px; width: 100%; position: relative; padding-left: 40px; }
        .roadmap-line { position: absolute; left: 19px; top: 0; bottom: 0; width: 4px; background: linear-gradient(180deg, var(--accent) 0%, var(--line-color) 10%, var(--line-color) 90%, var(--success) 100%); border-radius: 4px; z-index: 0; }

        .stage-block { background: var(--card-bg); border: 1px solid var(--line-color); border-radius: 16px; padding: 30px; margin-bottom: 60px; position: relative; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); transition: all 0.3s ease; }
        .stage-dot { position: absolute; left: -53px; top: 30px; width: 34px; height: 34px; background: var(--bg-dark); border: 4px solid var(--accent); border-radius: 50%; z-index: 2; box-shadow: 0 0 15px var(--accent-glow); cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: grid; place-items: center; color: var(--bg-dark); font-size: 16px; }
        .stage-dot:hover { transform: scale(1.2); border-color: var(--success); box-shadow: 0 0 20px rgba(74, 222, 128, 0.6); }

        .stage-block.completed { opacity: 0.5; filter: grayscale(0.8); border-color: var(--line-color); background: rgba(30, 41, 59, 0.5); }
        .stage-block.completed .stage-dot { background: var(--success); border-color: var(--success); color: white; box-shadow: 0 0 0 rgba(0,0,0,0); }
        .stage-block.completed .stage-dot::after { content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        .stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--line-color); padding-bottom: 15px; }
        .stage-title { font-size: 24px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .stage-meta { font-size: 14px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px; }

        /* Step Items */
        .step-list { list-style: none; padding: 0; margin: 0; }
        .step-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; padding: 12px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border-left: 3px solid var(--line-color); cursor: pointer; transition: all 0.2s ease; position: relative; }
        .step-item:hover { background: rgba(56, 189, 248, 0.05); }
        .step-item.critical { border-left-color: var(--warning); background: rgba(248, 113, 113, 0.05); }
        .step-item.action { border-left-color: var(--accent); }
        .step-item.decision { border-left-color: #a855f7; background: rgba(168, 85, 247, 0.05); }

        .step-checkbox { appearance: none; min-width: 20px; height: 20px; border: 2px solid var(--text-muted); border-radius: 4px; margin-top: 3px; cursor: pointer; display: grid; place-content: center; transition: all 0.2s; }
        .step-checkbox::before { content: ""; width: 10px; height: 10px; background: var(--bg-dark); transform: scale(0); transition: 0.2s transform ease-in-out; box-shadow: inset 1em 1em var(--bg-dark); transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }

        /* Completed State */
        .step-item.completed { opacity: 0.5; background: rgba(15, 23, 42, 0.3); border-left-color: #475569; }
        .step-item.completed .step-title { text-decoration: line-through; color: #64748b; }
        .step-item.completed .step-checkbox { background-color: var(--success); border-color: var(--success); }
        .step-item.completed .step-checkbox::before { transform: scale(1); background-color: white; }

        .step-icon { margin-top: 3px; width: 20px; text-align: center; }
        .step-content { flex: 1; }
        .step-title { font-weight: 600; display: block; margin-bottom: 4px; font-size: 16px; }
        .step-desc { font-size: 14px; color: var(--text-muted); line-height: 1.4; transition: color 0.2s; }

        /* Gate Styles */
        .gate-block { background: rgba(56, 189, 248, 0.05); border: 2px dashed var(--accent); border-radius: 12px; padding: 20px; margin-top: 20px; position: relative; }
        .gate-label { position: absolute; top: -14px; left: 20px; background: var(--bg-dark); color: var(--accent); padding: 0 10px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: 1px solid var(--accent); border-radius: 4px; }
        .gate-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 10px; }
        .gate-req { background: var(--bg-dark); padding: 10px; border-radius: 6px; text-align: center; border: 1px solid var(--line-color); transition: all 0.3s; }
        .gate-req h4 { margin: 0 0 5px 0; font-size: 13px; color: var(--text-muted); }
        .gate-req p { margin: 0; font-size: 14px; font-weight: 600; }
        .gate-req.stop { border-color: var(--warning); color: var(--warning); }
        
        /* Auto-Filled Gate */
        .gate-req.autofilled { border-color: var(--success); color: var(--success); background: rgba(74, 222, 128, 0.1); }
        .gate-req.autofilled::after { content: "\f00c"; font-family: "Font Awesome 6 Free"; margin-left: 5px; }

        .arrow-down { text-align: center; font-size: 24px; color: var(--text-muted); margin: -40px 0 20px 0; z-index: 2; position: relative; background: var(--bg-dark); width: 40px; height: 40px; display: grid; place-items: center; border-radius: 50%; border: 2px solid var(--line-color); left: -20px; }
        
        .reset-btn { margin-top: 40px; background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: 'Urbanist', sans-serif; transition: all 0.2s; }
        .reset-btn:hover { border-color: var(--warning); color: var(--warning); }
        
        /* Tooltip hint */
        .click-hint { position: absolute; left: -160px; top: 35px; font-size: 12px; color: var(--success); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .stage-block:hover .click-hint { opacity: 1; }

        /* --- TOAST NOTIFICATION STYLES --- */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--warning);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .toast.success { background-color: var(--success); color: var(--bg-dark); }
    </style>
</head>
<body>

    <div class="hubspot-bar">
        <div class="bar-header">
            <div class="bar-title">
                <i class="fa-brands fa-hubspot" style="font-size: 24px;"></i> HubSpot Connection
            </div>
            <div>
                <span class="status-badge status-offline" id="statusOffline">Offline Mode</span>
                <span class="status-badge status-online" id="statusOnline">Connected</span>
            </div>
        </div>
        <div class="bar-controls">
            <input type="text" id="dealIdInput" class="hs-input" placeholder="Enter Deal ID (e.g. 1234567890)">
            <button class="hs-btn" id="loadDealBtn">Load Deal</button>
            <div class="spinner" id="loadingSpinner"></div>
        </div>
        
        <div class="deal-context" id="dealContext">
            <strong>Active Deal:</strong> 
            <span id="dealNameDisplay">...</span>
            <span id="dealStageDisplay" class="stage-tag"></span>
        </div>
    </div>

    <h1>The Deal Navigator</h1>
    <h2>Select Deal Name 2.0</h2>

    <div class="roadmap-container">
        <div class="roadmap-line"></div>

        <div class="stage-block" id="stage-0">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="click-hint">Click dot to complete &rarr;</div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-flag-checkered"></i> 0. The Setup</div>
                <div class="stage-meta">Pre-Deal Work</div>
            </div>
            
            <ul class="step-list">
                <li class="step-item action" data-hs-obj="company" data-hs-prop="hubspot_owner_id">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-user-plus" style="color: var(--accent);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Create/Identify Contact</span>
                        <span class="step-desc">Find the Champion. Ensure full name & title. Assign association label: <strong>'Champion'</strong>.</span>
                    </div>
                </li>
                <li class="step-item critical" data-hs-obj="company" data-hs-prop="name" id="company-name-item">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-building" style="color: var(--warning);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Validate Company Record (Crucial)</span>
                        <span class="step-desc">Go to 'About this company' panel. You <strong>MUST</strong> update:
                            <br>1. Company Name (Internal DB)
                            <br>2. Company Owner (You)
                            <br>3. Potential Sites & Pools
                            <br><br><strong style="color: var(--accent);">Note:</strong> This happens <strong>once per company</strong> (1st deal only). For existing companies, skip straight to "Create Deal".
                        </span>
                    </div>
                    <span class="info-badge" id="companyNameBadge">
                        <i class="fa-solid fa-building"></i>
                        <span id="companyNameText">...</span>
                    </span>
                </li>
                <li class="step-item critical" data-hs-obj="company" data-hs-prop="hubspot_owner_id" id="company-owner-item">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-user-tie" style="color: var(--warning);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Company Owner Assignment</span>
                        <span class="step-desc">Verify the company owner is correctly assigned.</span>
                    </div>
                    <span class="info-badge" id="companyOwnerBadge">
                        <i class="fa-solid fa-user-tie"></i>
                        <span id="companyOwnerText">...</span>
                    </span>
                </li>
                <li class="step-item critical" data-hs-obj="company" data-hs-prop="customer_potential_sites" id="company-pools-sites-item">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-water-ladder" style="color: var(--warning);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Potential Sites & Pools</span>
                        <span class="step-desc">Enter estimated number of sites and pools for this customer.</span>
                    </div>
                    <span class="info-badge" id="companySitesPoolsBadge">
                        <i class="fa-solid fa-chart-simple"></i>
                        <span id="companySitesPoolsText">...</span>
                    </span>
                </li>
                <li class="step-item action" data-hs-obj="deal" data-hs-prop="dealname">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-plus-circle" style="color: var(--success);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Create Deal</span>
                        <span class="step-desc">Click "+ Add Deal". Select <strong>Long-Term Pipeline</strong> (Prospecting or New Builds).</span>
                    </div>
                </li>
            </ul>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-1">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-seedling"></i> 1. Long-Term Pipeline</div>
                <div class="stage-meta">Nurturing Phase</div>
            </div>
            
            <div class="gate-block">
                <div class="gate-label"><i class="fa-solid fa-lock"></i> Gate: Moving to Analysis</div>
                <p style="margin: 0 0 10px 0; font-size: 14px;">Fill <strong>Pre Qualification (5/5)</strong> in Validation Tab.</p>
                
                <div class="gate-grid">
                    <div class="gate-req" data-gate-prop="sla_signature_timeframe_is_within_the_upcoming_5_months_">
                        <h4>SLA Timeframe</h4>
                        <p>Within 5 Mo?</p>
                    </div>
                    <div class="gate-req" data-gate-prop="budget_availability_options">
                        <h4>Budget</h4>
                        <p>Viable Year</p>
                    </div>
                    <div class="gate-req" data-gate-prop="identified_deal_blockers_will_not_withhold_contract_signature_within_the_next_4_months" data-gate-negative="true">
                        <h4>Blockers?</h4>
                        <p>Must be "No"</p>
                    </div>
                    <div class="gate-req" data-gate-prop="estimated__go_live__date">
                        <h4>Go-Live</h4>
                        <p>Est. Qtr</p>
                    </div>
                    <div class="gate-req" data-gate-prop="key_materials_sent_to_prospect">
                        <h4>Materials</h4>
                        <p>Pick at least one</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-2">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-magnifying-glass-chart"></i> 2. Analysis</div>
                <div class="stage-meta">Sales Pipeline Entry</div>
            </div>

            <ul class="step-list">
                <li class="step-item action">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-water-ladder" style="color: var(--accent);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Update Line Items (Pools)</span>
                        <span class="step-desc">Before moving forward, edit the Line Items on the deal. Update <strong>Pool Type</strong> & <strong>Characteristics</strong>.</span>
                    </div>
                </li>
                <li class="step-item critical">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-clipboard-check" style="color: var(--warning);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Check Monitoring Specification</span>
                        <span class="step-desc">Ensure each pool's monitoring specification is set to the default: <strong>'commercial and operational'</strong>.</span>
                    </div>
                </li>
            </ul>

            <div class="gate-block">
                <div class="gate-label"><i class="fa-solid fa-lock"></i> Gate: Moving to Commitment</div>
                <p style="margin: 0 0 10px 0; font-size: 14px;">Fill <strong>Pre Commitment Info (3/7)</strong>.</p>
                <div class="gate-grid">
                    <div class="gate-req" data-gate-prop="commitment__document_type_">
                        <h4>Doc Type</h4>
                        <p>Select</p>
                    </div>
                    <div class="gate-req" data-gate-prop="recent_commitment_send_date">
                        <h4>Send Date</h4>
                        <p>Mandatory</p>
                    </div>
                    <div class="gate-req" data-gate-prop="site_it_partner">
                        <h4>IT Partner</h4>
                        <p>Identify</p>
                    </div>
                </div>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 10px; text-align: right;">*Ops trigger optional here.</p>
            </div>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-3">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-file-contract"></i> 3. Commitment</div>
                <div class="stage-meta">Signing Phase</div>
            </div>

            <div class="gate-block">
                <div class="gate-label"><i class="fa-solid fa-lock"></i> Gate: Moving to Setup</div>
                <p style="margin: 0 0 10px 0; font-size: 14px;">Fill <strong>Commitment Info (8 req)</strong>.</p>
                <div class="gate-grid">
                    <div class="gate-req stop" data-gate-prop="signed_commitment_file">
                        <h4>Signed File</h4>
                        <p>MUST Attach</p>
                    </div>
                    <div class="gate-req" data-gate-prop="recent_commitment_sig__date">
                        <h4>Sig. Date</h4>
                        <p>Date</p>
                    </div>
                    <div class="gate-req" data-gate-prop="commitment__document_type_">
                        <h4>Doc Type</h4>
                        <p>Check/Update</p>
                    </div>
                    <div class="gate-req" data-gate-prop="contract_term__in_years_">
                        <h4>Contract Term</h4>
                        <p>36 Mo (Default)</p>
                    </div>
                    <div class="gate-req" data-gate-prop="budget_approval">
                        <h4>Approvals</h4>
                        <p>Asset/Budget</p>
                    </div>
                    <div class="gate-req" style="grid-column: span 2;" data-gate-prop="poc_associated">
                        <h4>PoC Association</h4>
                        <p>Associate Contact &rarr; Auto-Yes</p>
                    </div>
                    <div class="gate-req" style="grid-column: span 2; border-color: var(--accent);" data-gate-prop="estimated__go_live__date">
                        <h4 style="color: var(--accent);">Go-Live Date Change</h4>
                        <p>Specific Day in Month</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-4">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-tools"></i> 4. Setup</div>
                <div class="stage-meta">Implementation</div>
            </div>

            <ul class="step-list">
                <li class="step-item decision">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-code-branch" style="color: #a855f7;"></i></div>
                    <div class="step-content">
                        <span class="step-title">Path Decision: Test Results</span>
                        <span class="step-desc">
                            <i class="fa-solid fa-check" style="color: var(--success);"></i> <strong>Pass:</strong> Move directly to <strong>Stage 6</strong> (Go-Live Validation).<br>
                            <i class="fa-solid fa-triangle-exclamation" style="color: var(--warning);"></i> <strong>Need Training:</strong> Move to <strong>Stage 5</strong> (Soft Launch).
                        </span>
                    </div>
                </li>
            </ul>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-5">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-stopwatch"></i> 5. Soft Launch (Optional)</div>
                <div class="stage-meta">Testing Phase</div>
            </div>
            
            <ul class="step-list">
                <li class="step-item action">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-info-circle" style="color: var(--accent);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Testing Period</span>
                        <span class="step-desc">Site operations, watch activation, and staff training occur here.</span>
                    </div>
                </li>
            </ul>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-6">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header">
                <div class="stage-title"><i class="fa-solid fa-rocket"></i> 6. Go-Live Validation</div>
                <div class="stage-meta">The Final Hurdle</div>
            </div>

            <ul class="step-list">
                <li class="step-item critical">
                    <input type="checkbox" class="step-checkbox">
                    <div class="step-icon"><i class="fa-solid fa-file-invoice-dollar" style="color: var(--warning);"></i></div>
                    <div class="step-content">
                        <span class="step-title">Update Line Items (Final Billing Dates)</span>
                        <span class="step-desc"><strong>Crucial:</strong> Update <strong>Handover Date</strong> & <strong>Billing Start Date</strong> for <em>each</em> pool to match Go-Live date.</span>
                    </div>
                </li>
            </ul>

            <div class="gate-block">
                <div class="gate-label"><i class="fa-solid fa-lock"></i> Gate: Moving to Go-Live</div>
                <p style="margin: 0 0 10px 0; font-size: 14px;">Fill <strong>Go-Live Info (Total 10 Req)</strong>.</p>
                
                <div style="margin-bottom: 10px; font-size: 12px; color: var(--accent); font-weight: 700; letter-spacing: 1px;">OPERATIONAL CHECK</div>
                <div class="gate-grid" style="margin-bottom: 20px;">
                    <div class="gate-req" data-gate-prop="number_of_watches">
                        <h4>Watches</h4>
                        <p>Quantity</p>
                    </div>
                    <div class="gate-req" data-gate-prop="all_site_watches_have_been_activated_">
                        <h4>Activated</h4>
                        <p>Yes/Partially</p>
                    </div>
                    <div class="gate-req stop" data-gate-prop="site_staff_had_a_training_session_">
                        <h4>Training</h4>
                        <p>Must be Yes</p>
                    </div>
                </div>

                <div style="margin-bottom: 10px; font-size: 12px; color: var(--accent); font-weight: 700; letter-spacing: 1px;">COMPLIANCE CHECK</div>
                <div class="gate-grid">
                    <div class="gate-req stop" data-gate-prop="it_approval_received">
                        <h4>IT & Security</h4>
                        <p>Must be YES</p>
                    </div>
                    <div class="gate-req" data-gate-prop="security_gdpr_approval">
                        <h4>GDPR</h4>
                        <p>Confirm 3 Qs</p>
                    </div>
                    <div class="gate-req" data-gate-prop="signed_commitment_file">
                        <h4>Signed File</h4>
                        <p>Verify</p>
                    </div>
                    <div class="gate-req" style="grid-column: span 3; border-color: var(--accent);" data-gate-prop="handover_date__atp_fulfillment_">
                        <h4 style="color: var(--accent);">Live Related Dates</h4>
                        <p>Update Handover & Billing Start.<br>(Same date unless Trial)</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="arrow-down"><i class="fa-solid fa-arrow-down"></i></div>

        <div class="stage-block" id="stage-7">
            <div class="stage-dot" title="Click to complete stage"></div>
            <div class="stage-header" style="border-bottom: none; margin-bottom: 0;">
                <div class="stage-title" style="color: var(--success);"><i class="fa-solid fa-sack-dollar"></i> 7. Paying</div>
                <div class="stage-meta" style="color: var(--success); border: 1px solid var(--success);">Success</div>
            </div>
            <p style="margin-top: 15px; font-size: 14px; text-align: center; color: var(--text-muted);">
                <i class="fa-solid fa-robot"></i> <strong>Automated:</strong> Deal moves here exactly 30 days after entering Go-Live.
            </p>
        </div>

        <button class="reset-btn" id="resetBtn">Reset All Checkboxes</button>
        
        <div id="toast" class="toast">Error message here</div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI Elements
            const stages = document.querySelectorAll('.stage-block');
            const steps = document.querySelectorAll('.step-item');
            const resetBtn = document.getElementById('resetBtn');
            const loadDealBtn = document.getElementById('loadDealBtn');
            const dealIdInput = document.getElementById('dealIdInput');
            const statusOffline = document.getElementById('statusOffline');
            const statusOnline = document.getElementById('statusOnline');
            const dealNameDisplay = document.getElementById('dealNameDisplay');
            const dealStageDisplay = document.getElementById('dealStageDisplay');
            const dealContext = document.getElementById('dealContext');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const toast = document.getElementById('toast');

            // Company Info Badge Elements
            const companyNameBadge = document.getElementById('companyNameBadge');
            const companyNameText = document.getElementById('companyNameText');
            const companyOwnerBadge = document.getElementById('companyOwnerBadge');
            const companyOwnerText = document.getElementById('companyOwnerText');
            const companySitesPoolsBadge = document.getElementById('companySitesPoolsBadge');
            const companySitesPoolsText = document.getElementById('companySitesPoolsText');

            // State Management
            const STATE_KEY = 'dealNavigatorStages';
            const CHECK_KEY = 'dealNavigatorChecks';
            const savedState = JSON.parse(localStorage.getItem(STATE_KEY)) || {};
            const savedChecks = JSON.parse(localStorage.getItem(CHECK_KEY)) || {};

            // --- UTILITIES ---
            const showToast = (msg, type = 'error') => {
                toast.innerText = msg;
                toast.className = `toast show ${type === 'success' ? 'success' : ''}`;
                setTimeout(() => { 
                    toast.className = toast.className.replace('show', ''); 
                }, 3000);
            };

            const updateLocalStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));

            // --- INITIALIZATION ---
            // Restore Stage State (Big Dots)
            stages.forEach((stage) => {
                if (savedState[stage.id]) {
                    stage.classList.add('completed');
                }
                const dot = stage.querySelector('.stage-dot');
                if(dot) {
                    dot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isComplete = stage.classList.toggle('completed');
                        if (isComplete) {
                            savedState[stage.id] = true;
                        } else {
                            delete savedState[stage.id];
                        }
                        updateLocalStorage(STATE_KEY, savedState);
                    });
                }
            });

            // Restore Checkbox State
            steps.forEach((step, index) => {
                const checkbox = step.querySelector('.step-checkbox');
                if (savedChecks[index]) {
                    checkbox.checked = true;
                    step.classList.add('completed');
                }

                step.addEventListener('click', (e) => {
                    if (e.target === checkbox) return; 

                    checkbox.checked = !checkbox.checked;
                    handleStepChange(step, index, checkbox.checked);
                });

                checkbox.addEventListener('change', () => {
                    handleStepChange(step, index, checkbox.checked);
                });
            });

            function handleStepChange(step, index, isChecked) {
                if (isChecked) {
                    step.classList.add('completed');
                    savedChecks[index] = true;
                } else {
                    step.classList.remove('completed');
                    delete savedChecks[index];
                }
                updateLocalStorage(CHECK_KEY, savedChecks);
            }

            resetBtn.addEventListener('click', () => {
                if(confirm('Are you sure you want to clear all progress?')) {
                    localStorage.removeItem(STATE_KEY);
                    localStorage.removeItem(CHECK_KEY);
                    location.reload(); 
                }
            });

            // --- HUBSPOT INTEGRATION LOGIC ---
            loadDealBtn.addEventListener('click', async () => {
                const dealId = dealIdInput.value.trim();
                if (!dealId) return showToast('Please enter a Deal ID');

                setLoading(true);

                try {
                    const response = await fetch(`/api/deal-status?dealId=${dealId}`);
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'Failed to fetch deal');

                    // Success!
                    statusOffline.classList.add('hidden');
                    statusOnline.classList.add('active');
                    dealContext.style.display = 'block';
                    
                    // 1. Set Name
                    dealNameDisplay.innerText = data.deal?.dealname || 'Unnamed Deal';

                    // 2. Set Stage (WITH DICTIONARY MAPPING)
                    const rawStage = data.deal?.dealstage;
                    
                    const stageDictionary = {
                        // Sales Pipeline
                        'appointmentscheduled': 'Analysis',
                        '1881591013': 'Commitment',
                        'decisionmakerboughtin': 'Setup',
                        '1881591014': 'Soft Launch',
                        '223218406': 'Go-Live',
                        '483245762': 'Paying',

                        // Long Term Pipeline
                        '1881591003': 'Prospecting',
                        '1881591004': 'New Builds',
                        '1881591002': 'Stuck'
                    };

                    if (rawStage) {
                        const finalStageName = stageDictionary[rawStage] || rawStage;
                        
                        dealStageDisplay.innerText = finalStageName;
                        dealStageDisplay.style.display = 'inline-block';
                        
                        // Optional: Highlight "Paying" or "Closed Won" in Green
                        if(rawStage === '483245762' || rawStage === 'closedwon') {
                             dealStageDisplay.style.borderColor = 'var(--success)';
                             dealStageDisplay.style.color = 'var(--success)';
                             dealStageDisplay.style.backgroundColor = 'rgba(74, 222, 128, 0.1)';
                        }
                    } else {
                        dealStageDisplay.style.display = 'none';
                    }
                    
                    showToast('Deal Loaded Successfully', 'success');
                    
                    // 3. Display Company Info Badges
                    displayCompanyInfo(data);
                    
                    // 4. AUTO-CHECK LOGIC
                    checkProperties(data);

                } catch (err) {
                    console.error(err);
                    showToast(err.message);
                    statusOnline.classList.remove('active');
                    statusOffline.classList.remove('hidden');
                } finally {
                    setLoading(false);
                }
            });

            function setLoading(isLoading) {
                loadDealBtn.disabled = isLoading;
                loadDealBtn.innerText = isLoading ? 'Fetching...' : 'Load Deal';
                loadingSpinner.style.display = isLoading ? 'block' : 'none';
            }

            function displayCompanyInfo(data) {
                const company = data.company;
                const owner = data.owner;

                // A. Company Name Badge
                if (company && company.name) {
                    companyNameText.innerText = company.name;
                    companyNameBadge.classList.remove('missing-data');
                    companyNameBadge.classList.add('has-data');
                } else {
                    companyNameText.innerText = 'Not Set';
                    companyNameBadge.classList.remove('has-data');
                    companyNameBadge.classList.add('missing-data');
                }
                companyNameBadge.style.display = 'flex';

                // B. Company Owner Badge
                if (owner && owner.firstName && owner.lastName) {
                    companyOwnerText.innerText = `${owner.firstName} ${owner.lastName}`;
                    companyOwnerBadge.classList.remove('missing-data');
                    companyOwnerBadge.classList.add('has-data');
                } else if (company && company.hubspot_owner_id) {
                    // Fallback to ID if we couldn't fetch owner details
                    companyOwnerText.innerText = `ID: ${company.hubspot_owner_id}`;
                    companyOwnerBadge.classList.remove('missing-data');
                    companyOwnerBadge.classList.add('has-data');
                } else {
                    companyOwnerText.innerText = 'Not Assigned';
                    companyOwnerBadge.classList.remove('has-data');
                    companyOwnerBadge.classList.add('missing-data');
                }
                companyOwnerBadge.style.display = 'flex';

                // C. Sites & Pools Badge
                const sites = company?.customer_potential_sites;
                const pools = company?.customer_potential_pools;
                
                if (sites || pools) {
                    const sitesDisplay = sites || '0';
                    const poolsDisplay = pools || '0';
                    companySitesPoolsText.innerText = `Sites: ${sitesDisplay} | Pools: ${poolsDisplay}`;
                    companySitesPoolsBadge.classList.remove('missing-data');
                    companySitesPoolsBadge.classList.add('has-data');
                } else {
                    companySitesPoolsText.innerText = 'Not Set';
                    companySitesPoolsBadge.classList.remove('has-data');
                    companySitesPoolsBadge.classList.add('missing-data');
                }
                companySitesPoolsBadge.style.display = 'flex';
            }

            function checkProperties(data) {
                if (!data.deal) return;
                
                const deal = data.deal;
                const company = data.company || {};

                const isValid = (val) => val && val !== '' && val !== 'No' && val !== 'false';

                // 1. MAP GATES
                document.querySelectorAll('.gate-req').forEach(gate => {
                    const prop = gate.getAttribute('data-gate-prop');
                    const isNegativeCheck = gate.getAttribute('data-gate-negative') === 'true';
                    
                    const val = deal[prop];
                    
                    if (val !== undefined) {
                        let passed = false;
                        if (isNegativeCheck) {
                            // NEW: Check for "N/A", "No", or "false" explicitly
                            if (val === 'No' || val === 'false' || val === 'N/A') passed = true;
                        } else {
                            if (isValid(val)) passed = true;
                        }

                        if (passed) {
                            gate.classList.add('autofilled');
                            
                            // Special handling for document type - show the actual value
                            if (prop === 'commitment__document_type_') {
                                const valueDisplay = gate.querySelector('p');
                                if (valueDisplay) {
                                    valueDisplay.innerText = val;
                                }
                            }
                        } else {
                            // If document type is empty/invalid, show in red
                            if (prop === 'commitment__document_type_') {
                                gate.classList.add('stop');
                                const valueDisplay = gate.querySelector('p');
                                if (valueDisplay) {
                                    valueDisplay.innerText = 'NOT SET';
                                }
                            }
                        }
                    } else {
                        // Value is undefined - mark as missing for document type
                        if (prop === 'commitment__document_type_') {
                            gate.classList.add('stop');
                            const valueDisplay = gate.querySelector('p');
                            if (valueDisplay) {
                                valueDisplay.innerText = 'NOT SET';
                            }
                        }
                    }
                });

                // 2. MAP CHECKLIST ITEMS
                document.querySelectorAll('.step-item').forEach((step, index) => {
                    const objType = step.getAttribute('data-hs-obj');
                    const propName = step.getAttribute('data-hs-prop');
                    
                    if (!objType || !propName) return;

                    let targetData = objType === 'company' ? company : deal;
                    
                    if (targetData && isValid(targetData[propName])) {
                        const checkbox = step.querySelector('.step-checkbox');
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            handleStepChange(step, index, true);
                        }
                    }
                });
            }
        });
    </script>

</body>
</html>
